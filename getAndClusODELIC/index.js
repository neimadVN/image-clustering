const fs = require('fs');
const path = require('path');
const { imageHash } = require('image-hash');
const fsExtra = require('fs-extra');

const productCodes = [
  'OC257235',
'OC257236',
'OC257237',
'OC257238',
'OC257239',
'OC257240',
'OC257229',
'OC257230',
'OC257231',
'OC257232',
'OC257233',
'OC257234',
'OC257241BC',
'OC257242BC',
'OC257243BC',
'OC257244BC',
'OC257245BC',
'OC257246BC',
'OC257248BR',
'OC257247BR',
'OL251428NGR',
'OL251584NGR',
'OL291436NGR',
'OL291437NGR',
'OL291482NGR',
'OL291483NGR',
'OL291505NGR',
'OL291506NGR',
'OL291327NGR',
'OL291328NGR',
'OL291323NGR',
'OL291324NGR',
'OL291319NGR',
'OL291320NGR',
'OL291553NGR',
'OL291554NGR',
'OL291557NGR',
'OL291558NGR',
'OL291561NGR',
'OL291562NGR',
'OL251823NGR',
'OL251816NGR',
'OL251618NGR',
'OL251814NGR',
'OL251614NGR',
'OL251219NGR',
'OL251278NGR',
'OL251818NGR',
'OL251498NGR',
'OL251820NGR',
'OL291013NGR',
'OL291014NGR',
'OL291019NGR',
'OL291020NGR',
'OL291016NGR',
'OL291017NGR',
'OL291668BR',
'OL291669BR',
'OL291662BR',
'OL291663BR',
'OL291664BR',
'OL291665BR',
'OL291666BR',
'OL291667BR',
'OL251197R2',
'OL251617R1',
'OL251198R1',
'OL251618R1',
'OL251814R1',
'OL251197BCR2',
'OL251617BCR1',
'OL251198BCR1',
'OL251618BCR1',
'OL251814BCR1',
'OL251617BRE1',
'OL251198BRE1',
'OL291673NR',
'OL291673WR',
'OL291673LR',
'OL291674NR',
'OL291674WR',
'OL291674LR',
'OL291484NR1',
'OL291484LR1',
'OL291484BR1',
'WF237P1',
'WF239P1',
'WF249P1',
'WF257PR',
'WF258PR',
'WF259PR',
'WF260PR',
'WF287PR',
'WF288PR',
'WF289PR',
'WF290PR',
'WF731P1',
'WF732P1',
'WF733P1',
'WF734P1',
'WF735P1',
'WF736P1',
'WF737P1',
'WF738P1',
'WF739P1',
'WF740P1',
'WF741P1',
'WF742P1',
'WF277PR1',
'WF278PR1',
'WF813P1',
'WF811P1',
'WF081P1',
'WF080P1',
'WF090P1',
'WF091P1',
'WF611P1',
'WF612P1',
'WF613P1',
'WF614P1',
'WF615P1',
'WF616P1',
'WF831P1',
'WF833P1',
'WF836P1',
'WF837P1',
'WF838P1',
'WF801P2',
'WF803P2',
'WF802P2',
'WF972P1',
'WF973P1',
'WF976P1',
'WF979P1',
'WF982P1',
'WF983P1',
'WF986P1',
'WF989P1',
'WF441PR',
'WF442PR',
'WF402P1',
'WF404P1',
'WF406P1',
'WF401P1',
'WF403P1',
'WF405P1',
'WF643P1',
'WF646P1',
'WF649P1',
'WF653P1',
'WF656P1',
'WF659P1',
'WF663P1',
'WF666P1',
'WF669P1',
'WF504P1',
'WF506P1',
'WF503P1',
'WF505P1',
'OP252988LR',
'OP252989LR',
'OP252988LCR',
'OP252989LCR',
'OP252986LR',
'OP252986NR',
'OP252986WR',
'OP252987LR',
'OP252987NR',
'OP252987WR',
'OP252986BR',
'OP252987BR',
'OP273005LR',
'OP273005NR',
'OP273005WR',
'OP273006LR',
'OP273006NR',
'OP273006WR',
'OP273005BR',
'OP273006BR',
'OP273001LR',
'OP273001NR',
'OP273001WR',
'OP273002LR',
'OP273002NR',
'OP273002WR',
'OP273001BR',
'OP273002BR',
'OP273003LR',
'OP273003NR',
'OP273003WR',
'OP273004LR',
'OP273004NR',
'OP273004WR',
'OP273003BR',
'OP273004BR',
'OP252974LR',
'OP252974NR',
'OP252974WR',
'OP252975LR',
'OP252975NR',
'OP252975WR',
'OP252974BR',
'OP252975BR',
'OP252976LR',
'OP252976NR',
'OP252976WR',
'OP252977LR',
'OP252977NR',
'OP252977WR',
'OP252976BR',
'OP252977BR',
'OP252978LR',
'OP252978NR',
'OP252978WR',
'OP252979LR',
'OP252979NR',
'OP252979WR',
'OP252978BR',
'OP252979BR',
'OP252984LR',
'OP252984NR',
'OP252984WR',
'OP252985LR',
'OP252985NR',
'OP252985WR',
'OP252984BR',
'OP252985BR',
'OP252980LR',
'OP252980NR',
'OP252980WR',
'OP252981LR',
'OP252981NR',
'OP252981WR',
'OP252980BR',
'OP252981BR',
'OP252990LCR',
'OP252991LCR',
'OP252990BR',
'OP252991BR',
'OP252992LCR',
'OP252992BR',
'OP252993LC',
'OP252994LC',
'OP252995LC',
'OP273007LC',
'OP273008LC',
'OP252477LD3',
'OP252478LD1',
'OP252479LD3',
'OP252480LD1',
'OP252481LD3',
'OP252482LD1',
'OB255383LR',
'OB255383LCR',
'OB255382LR',
'OB255382NR',
'OB255382WR',
'OB255382BR',
'OB255380LR',
'OB255380NR',
'OB255380WR',
'OB255380BR',
'OB255378LR',
'OB255378NR',
'OB255378WR',
'OB255378BR',
'OB255379LR',
'OB255379NR',
'OB255379WR',
'OB255379BR',
'OB255376LR',
'OB255376NR',
'OB255376WR',
'OB255376BR',
'OB255377LR',
'OB255377NR',
'OB255377WR',
'OB255377BR',
'OB255388LR',
'OB255388NR',
'OB255388WR',
'OB255388BR',
'OB255387LR',
'OB255387NR',
'OB255387WR',
'OB255387BR',
'OB255385LR',
'OB255385NR',
'OB255385WR',
'OB255385BR',
'OB255390LR',
'OB255390NR',
'OB255390WR',
'OB255390BR',
'OB255389LR',
'OB255389NR',
'OB255389WR',
'OB255389BR',
'OL291649NR',
'OL291649LR',
'OL291648NR',
'OL291648LR',
'OL291651NR',
'OL291651LR',
'OL291650NR',
'OL291650LR',
'OB255386LR',
'OB255386NR',
'OB255386WR',
'OB255384LR',
'OB255384NR',
'OB255384WR',
'OB555085RA',
'OB555089RA',
'OW269051LR',
'OW269051NR',
'OW269051BR',
'OW269051RG',
'OL291657BR',
'OL291658BR',
'OP252686R1',
'OP252685R1',
'OP252686BR1',
'OP252685BR1',
'OG264239LCR',
'OG264240LCR',
'OG254770LC1',
'OG254771LC1',
'OG254104LC2',
'OG254103LC2',
'OG264237LC',
'OG264238LC',
'OG254106LCR1',
'OG254105LCR1',
'OG264168LCR',
'OG264170LCR',
'OG264167LCR',
'OG264169LCR',
'OG264164LCR',
'OG264166LCR',
'OG264163LCR',
'OG264165LCR',
'OG264154LC',
'OG264153LC',
'OG264156LC',
'OG264155LC',
'OG264152LC',
'OG264151LC',
'OG264158LCR',
'OG264157LCR',
'OG264160LCR',
'OG264159LCR',
'OG264162LCR',
'OG264161LCR',
'OG264234',
'OG264233',
'OG264236',
'OG264235',
'OW009397LCR',
'OW009397NCR',
'OW009397WCR',
'OW009395LCR',
'OW009395NCR',
'OW009395WCR',
'OG254894LR',
'OG254894NR',
'OG254894WR',
'OG264178LCR',
'OG264177LCR',
'OG264180LCR',
'OG264179LCR',
'OG254054R1',
'OG254052R1',
'OG254019R1',
'OD361583',
'OD361584',
'OD361585',
'OD361592',
'OD361593',
'OD361594',
'OD361577',
'OD361578',
'OD361580',
'OD361581',
'OD361579',
'OD361582',
'OD361586',
'OD361587',
'OD361589',
'OD361590',
'OD361588',
'OD361591',
'OD361151R',
'OD361152R',
'OD361153R',
'OD361154R',
'OD361155R',
'OD361156R',
'OD361157R',
'OD361158R',
'OD361159R',
'OD361160R',
'OD361161R',
'OD361162R',
'OD301267',
'OD301268',
'OD301265',
'OD301266',
'OG264216',
'OG264214',
'OG264212',
'OG264215',
'OG264213',
'OG264211',
'OG264222',
'OG264220',
'OG264218',
'OG264221',
'OG264219',
'OG264217',
'OG264202LCR',
'OG264202NCR',
'OG264204LCR',
'OG264204NCR',
'OG264206LCR',
'OG264206NCR',
'OG264201LCR',
'OG264201NCR',
'OG264203LCR',
'OG264203NCR',
'OG264205LCR',
'OG264205NCR',
'OG264210',
'OG264208',
'OG264209',
'OG264207',
'OG264248R',
'OG264250R',
'OG264252R',
'OG264254R',
'OG264256R',
'OG264258R',
'OG264260R',
'OG264262R',
'OG264264R',
'OG264266R',
'OG264268R',
'OG264270R',
'OG264247R',
'OG264249R',
'OG264251R',
'OG264253R',
'OG264255R',
'OG264257R',
'OG264259R',
'OG264261R',
'OG264263R',
'OG264265R',
'OG264267R',
'OG264269R',
'OG264271R',
'OG264272R',
'OG264273R',
'OG264274R',
'OG264275R',
'OG264276R',
'OG254915R1',
'OG254916R1',
'OG254917R1',
'OG254918R1',
'OG254919R1',
'OG254920R1',
'OG264277R',
'OG264278R',
'OG264279R',
'OG264280R',
'OG264281R',
'OG264282R',
'OG254921R1',
'OG254922R1',
'OG254923R1',
'OG254924R1',
'OG254925R1',
'OG254926R1',
'OG254931R1',
'OG254932R1',
'OG254933R1',
'OG254934R1',
'OG254935R1',
'OG254936R1',
'OG254927R1',
'OG254928R1',
'OG254929R1',
'OG254930R1',
'OG264224R',
'OG264226R',
'OG264228R',
'OG264223R',
'OG264225R',
'OG264227R',
'OG264241R',
'OG264242R',
'OG264243R',
'OG264244R',
'OG264245R',
'OG264246R',
'OG264290',
'OG264291',
'OG264288',
'OG264289',
'OG264230LR',
'OG264230NR',
'OG264229LR',
'OG264229NR',
'ES400151',
'ES400152',
'ES400255',
'ES400301',
'ES400302',
'ES400304',
'ES400251',
'OD361603R',
'OD361604R',
'OD361605R',
'OD361606R',
'OD361607R',
'OD361608R',
'OD361573CR',
'OD361574CR',
'OD361575CR',
'OD361576CR',
'OD361285R',
'OD361286R',
'OD361287R',
'OD361288R',
'OD361289R',
'OD361290R',
'OD361291R',
'OD361292R',
'OD361293R',
'OD361294R',
'OD361295R',
'OD361296R',
'OD361115R',
'OD361116R',
'OD361117R',
'OD361118R',
'OD361119R',
'OD361120R',
'OD361125R',
'OD361126R',
'OD361127R',
'OD361128R',
'OD361129R',
'OD361130R',
'OD361599R',
'OD361600R',
'OD361601R',
'OD361602R',
'OD361595R',
'OD361596R',
'OD361597R',
'OD361598R',
'XD457130R',
'XD457131R',
'XD457134R',
'XD457135R',
'XD457138R',
'XD457139R',
'XD457128R',
'XD457129R',
'XD457132R',
'XD457133R',
'XD457136R',
'XD457137R',
'XA453055',
'XA453056',
'XA453057',
'XA453058',
'XS516101BR',
'XS516102BR',
'XS516103BR',
'XS516104BR',
'XS516105BR',
'XS516106BR',
'XS517101BR',
'XS517102BR',
'XS517103BR',
'XS517104BR',
'XS517105BR',
'XS517106BR',
'FLM0500T1B',
'FLM0500T1E',
'FLM0500T1F',
'FLM0400T1B',
'FLM0400T1E',
'FLM0400T1F',
'FLM0300T1B',
'FLM0300T1E',
'FLM0300T1F',
'FLM0200T1B',
'FLM0200T1E',
'FLM0200T1F',
'FLM0100T1B',
'FLM0100T1E',
'FLM0100T1F',
'OA253544',
'OA253543',
'OA253545',
'OA253516',
'OA253517',
'OA253518',
'FLM0500T3B',
'FLM0500T3E',
'FLM0500T3F',
'FLM0400T3B',
'FLM0400T3E',
'FLM0400T3F',
'FLM0300T3B',
'FLM0300T3E',
'FLM0300T3F',
'FLM0200T3B',
'FLM0200T3E',
'FLM0200T3F',
'FLM0100T3B',
'FLM0100T3E',
'FLM0100T3F',
'OA253541',
'OA253540',
'OA253542',
'FLM0500S3B',
'FLM0500S3E',
'FLM0500S3F',
'FLM0400S3B',
'FLM0400S3E',
'FLM0400S3F',
'FLM0300S3B',
'FLM0300S3E',
'FLM0300S3F',
'FLM0200S3B',
'FLM0200S3E',
'FLM0200S3F',
'FLM0100S3B',
'FLM0100S3E',
'FLM0100S3F',
'OA253538',
'OA253539',
'OA253532',
'FG5000RG',
'FG4000RG',
'FG3000RG',
'FG2000RG',
'FG1000RG',
'TLR0500RG',
'TLR0400RG',
'TLR0300RG',
'TLR0200RG',
'TLR0100RG',
'OA253522',
'OA253533',
'OA253535',
'OA253521',
'TLM0500B',
'TLM0500D',
'TLM0500E',
'TLM0500F',
'TLM0400B',
'TLM0400D',
'TLM0400E',
'TLM0400F',
'TLM0300B',
'TLM0300D',
'TLM0300E',
'TLM0300F',
'TLM0200B',
'TLM0200D',
'TLM0200E',
'TLM0200F',
'TLM0100B',
'TLM0100D',
'TLM0100E',
'TLM0100F',
'OA253520',
'OA253534',
'OA253536',
'OA253519',
'TLM0500LE',
'TLM0500LF',
'TLM0400LE',
'TLM0400LF',
'TLM0300LE',
'TLM0300LF',
'TLM0200LE',
'TLM0200LF',
'TLM0100LE',
'TLM0100LF',
'OA253549',
'OA253548',
'OA253551',
'OA253550',
'TF1002BC',
'TF0900BC',
'TF0801BC',
'TF0702BC',
'TF0600BC',
'TF0501BC',
'TF0402BC',
'TF0300BC',
'TF0240BC',
'TF0180BC',
'TF0120BC',
'TF0060BC',
'OA253523',
'OA253524',
'TF1002B',
'TF1002E',
'TF1002F',
'TF0900B',
'TF0900E',
'TF0900F',
'TF0801B',
'TF0801E',
'TF0801F',
'TF0702B',
'TF0702E',
'TF0702F',
'TF0600B',
'TF0600E',
'TF0600F',
'TF0501B',
'TF0501E',
'TF0501F',
'TF0402B',
'TF0402E',
'TF0402F',
'TF0300B',
'TF0300E',
'TF0300F',
'TF0240B',
'TF0240E',
'TF0240F',
'TF0180B',
'TF0180E',
'TF0180F',
'TF0120B',
'TF0120E',
'TF0120F',
'TF0060B',
'TF0060E',
'TF0060F',
'OL291475CR',
'OL291476CR',
'OL291477CR',
'OL291478CR',
'OA253804',
'OL291679R1B',
'OL291679R1C',
'OL291679R1D',
'OL291679R1E',
'OL291679R2B',
'OL291679R2C',
'OL291679R2D',
'OL291679R2E',
'OL291680R1B',
'OL291680R1C',
'OL291680R1D',
'OL291680R1E',
'OL291680R2B',
'OL291680R2C',
'OL291680R2D',
'OL291680R2E',
'OL291679R1M',
'OL291679R2M',
'OL291680R1M',
'OL291680R2M',
'OA253530',
'OA253531',
'OL291681R1B',
'OL291681R1C',
'OL291681R1D',
'OL291681R1E',
'OL291681R2B',
'OL291681R2C',
'OL291681R2D',
'OL291681R2E',
'OL291682R1B',
'OL291682R1C',
'OL291682R1D',
'OL291682R1E',
'OL291682R2B',
'OL291682R2C',
'OL291682R2D',
'OL291682R2E',
'OL291681R1M',
'OL291681R2M',
'OL291682R1M',
'OL291682R2M',
'UN6401RB',
'UN6401RC',
'UN6401RD',
'UN6401RE',
'UN6402RB',
'UN6402RC',
'UN6402RD',
'UN6402RE',
'UN6401RM',
'UN6402RM',
'XL551718R',
'XL551718RA',
'XL551718RB',
'XL551718RC',
'XL551718RD',
'XL551718RE',
'XL551717R',
'XL551717RA',
'XL551717RB',
'XL551717RC',
'XL551717RD',
'XL551717RE',
'XL501061BC',
'XL501062BC',
'XL501063BC',
'XL501064BC',
'XL501061',
'XL501062',
'XL501063',
'XL501064',
'XA453049',
'LC625',
'LC626',
'LC627',
'RC928',
'LC212P1',
'OA253471',
];

const imageDir = './image';
const thumbnailDir = './thumbnail';
const outputDir = './output';

async function getImageHash(imagePath) {
  return new Promise((resolve, reject) => {
    imageHash(imagePath, 16, true, (error, data) => {
      if (error) {
        reject(error);
      } else {
        resolve(data);
      }
    });
  });
}

async function findClusters() {
  const clusters = {};
  const imageHashes = {};

  for (const productCode of productCodes) {
    const thumbPath = path.join(thumbnailDir, `MAIN_${productCode}.jpg`);
    const imageHash = await getImageHash(thumbPath);

    if (!clusters[imageHash]) {
      clusters[imageHash] = [];
    }
    clusters[imageHash].push(productCode);
    imageHashes[productCode] = imageHash;
    console.log('ðŸš€ ~ findClusters ~ clusters:', clusters)
  }

  return clusters;
}

async function copyImagesToClusters(clusters) {
  let clusterIndex = 1;
  for (const hash in clusters) {
    const clusterDir = path.join(outputDir, `cluster${clusterIndex}`);
    await fsExtra.ensureDir(clusterDir);

    for (const productCode of clusters[hash]) {
      const srcImagePath = path.join(imageDir, `${productCode}.jpg`);
      const destImagePath = path.join(clusterDir, `${productCode}.jpg`);

      await fsExtra.copy(srcImagePath, destImagePath);
    }
    clusterIndex++;
  }
}

async function main() {
  try {
    const clusters = await findClusters();
    await copyImagesToClusters(clusters);
    console.log('Images segmented into clusters successfully.');
  } catch (err) {
    console.error('Error during processing:', err);
  }
}

main();